# Traffic Dashboard - Cursor Rules

## Project Overview

A traffic comparison dashboard showing internal traffic data vs Ahrefs data, with revenue tracking and DR (Domain Rating) history. Built with ApexCharts for visualization.

**Live URL:** https://traffic-dashboard-theta.vercel.app/
**Main Dashboard:** /index-apex.html
**Leaderboard:** /leaderboard.html
**Repository:** https://github.com/romesfallen/traffic-dashboard.git
**Branch:** master

---

## Deployment Instructions

When asked to "push", "deploy", "push live", or "push to Vercel":

1. Check git status for changes
2. Stage relevant files with `git add`
3. Commit with descriptive message using HEREDOC format:
   ```bash
   git commit -m "$(cat <<'EOF'
   Commit title here
   
   - Bullet point details
   EOF
   )"
   ```
4. Push to origin master: `git push origin master`
5. Vercel auto-deploys from GitHub
6. Provide URL: https://traffic-dashboard-theta.vercel.app/

---

## Current Features

### Search Engine Protection
- [x] robots.txt blocking all crawlers
- [x] Meta robots tags (noindex, nofollow, noarchive, nosnippet) on all pages
- [x] X-Robots-Tag HTTP header via vercel.json

### Authentication (Google OAuth)
- [x] Client-side auth check redirects to login if not authenticated
- [x] Google OAuth login flow via /api/auth endpoints
- [x] Email allowlist validation (ALLOWED_EMAILS env var)
- [x] 24-hour session cookies (HttpOnly, Secure)
- [x] User bar showing logged-in email with Sign Out button
- [x] Access denied page for non-approved emails
- [x] Page hidden until auth verified (prevents flash of content)

### Main Dashboard (index-apex.html)
- [x] ApexCharts line/area chart with traffic data
- [x] Dual traffic series: Internal Monthly Traffic vs Ahrefs Monthly Traffic
- [x] Revenue bars (stepped area, bottom-third of chart)
- [x] Revenue labels with toggle on/off
- [x] DR (Domain Rating) line with dotted style
- [x] Date range selector (7d, 30d, 90d, 6mo, 1yr, From Dec 2024, All time)
- [x] Searchable domain dropdown with keyboard navigation
- [x] Linear interpolation for missing data points
- [x] Zoom and pan functionality
- [x] Custom tooltip showing all series values
- [x] Revenue ranking bubbles above chart showing:
  - Lifetime Revenue rank, value, % of portfolio
  - Last 3 Months rank, value, % of portfolio (uses 3 complete calendar months, excludes current incomplete month)
  - Current Month rank, value, % of portfolio
  - Avg Last 3 Months value (no rank, no percentage)
- [x] Dynamic month calculations based on current date (auto-updates each month)
- [x] Centered domain title above ranking bubbles
- [x] URL parameter support (?domain=example.com)
- [x] Navigation link to Leaderboard

### Leaderboard (leaderboard.html)
- [x] Shows ALL domains with revenue > $0.01
- [x] Three tabs: Lifetime / Last 3 Months / Current Month
- [x] Sortable table: Rank, Domain, Revenue, % of Portfolio
- [x] Portfolio total displayed
- [x] Site count in subtitle
- [x] Clickable domains link to dashboard with pre-selected domain
- [x] Back to Dashboard link
- [x] Dynamic month calculations (Last 3 Months uses complete calendar months only)

### Sites by Agent (agent.html)
- [x] Agent selector buttons (dynamically loaded from CSV)
- [x] Three tabs: Lifetime / Last 3 Months / Current Month
- [x] Table showing: Rank, Domain, Niche, Revenue, % of Portfolio
- [x] Agent portfolio total displayed
- [x] Ahrefs links and copy domain buttons
- [x] Clickable domains link to main dashboard
- [x] Clickable niches link to niche.html
- [x] Dynamic month calculations (Last 3 Months uses complete calendar months only)
- [x] Rank change tracker on Current Month tab:
  - Shows position change vs previous complete month
  - Green up arrow (▲) with +N for improvements
  - Red down arrow (▼) with -N for declines
  - Star (★) with "new" for sites new to the rankings

### Sites by Niche (niche.html)
- [x] Similar structure to agent.html but filtered by niche
- [x] Dynamic month calculations (Last 3 Months uses complete calendar months only)

### Data Sources
- `traffic-data.csv` - Internal traffic by date (~14MB)
- `ahrefs_organic_traffic_results.csv` - Ahrefs organic traffic (~342KB)
- `revenue-history.csv` - Monthly revenue by domain (~455KB)
- `DR History.csv` - Domain Rating history (~7.5MB)
- `ahrefs-data.csv` - Legacy Ahrefs data (deprecated)

---

## CSV Format Specifications

> **CRITICAL:** If updating CSVs, maintain these exact formats. The dashboard will break if column names or structure changes.

### 1. traffic-data.csv (Internal Traffic)

**Format:** Wide format with dates as columns

| Column | Description | Example |
|--------|-------------|---------|
| (empty) | Row number (auto-generated) | `1` |
| Website | Domain name | `decoratoradvice.com` |
| Ahrefs Links | Link to Ahrefs for this domain | `https://app.ahrefs.com/...` |
| Link Working | Status field (optional) | - |
| Type | Category type | `Sales` |
| Original Type | Original category (optional) | - |
| `Mon D - YYYY` | Traffic value for that date | `16495` or `"54,316"` |

**Date column format:** `Mon D - YYYY` (e.g., `Jul 1 - 2024`, `Jan 15 - 2025`)

**Traffic values:** Can be plain numbers (`16495`) or comma-formatted strings (`"54,316"`)

**Example row:**
```
1,decoratoradvice.com,https://app.ahrefs.com/...,Sales,,,,11209,16495,16572,...
```

### 2. revenue-history.csv (Monthly Revenue)

**Format:** Wide format with months as columns

| Column | Description | Example |
|--------|-------------|---------|
| (header row 1) | Snapshot date | `1/19/26` |
| Purchase Price | Cost to acquire | `$1,500.00` |
| Live Date | When site went live | `Jan 2022 or earlier` |
| Website | Domain name | `betterthisworld.com` |
| Niche | Site category/niche | `General, Health, Business` |
| `Mon YYYY` | Revenue for that month | `$375.00` or `-` |
| Total | Lifetime revenue sum | `$610,244.64` |
| Count | Number of months with revenue | `49` |

**Month column format:** `Mon YYYY` (e.g., `Jan 2022`, `Dec 2025`)

**Revenue values:** 
- Dollar amounts with `$` and commas: `$1,500.00`, `$10,954.50`
- `-` for no data/not applicable
- Empty for no revenue that month

**Example row:**
```
Bought - Mohit,"$1,500.00",Jan 2022 or earlier,betterthisworld.com,"General, Health, Business",$375.00,$630.00,...,$610,244.64,49
```

### 3. ahrefs_organic_traffic_results.csv (Ahrefs Traffic)

**Format:** Long/tidy format (one row per domain per date)

| Column | Description | Example |
|--------|-------------|---------|
| domain | Domain name | `lyncconf.com` |
| date | ISO 8601 date | `2024-01-01T00:00:00Z` |
| organic_traffic | Traffic value (integer) | `2024` |

**Date format:** ISO 8601 with timezone: `YYYY-MM-DDTHH:MM:SSZ`

**Example rows:**
```
domain,date,organic_traffic
lyncconf.com,2024-01-01T00:00:00Z,2024
lyncconf.com,2024-01-02T00:00:00Z,1980
```

### 4. DR History.csv (Domain Rating)

**Format:** Wide format with dates as columns (same structure as traffic-data.csv)

| Column | Description | Example |
|--------|-------------|---------|
| (empty) | Row number | `1` |
| Website | Domain name | `decoratoradvice.com` |
| `Mon D - YYYY` | DR value for that date (0-100) | `57`, `72`, or empty |

**Date column format:** `Mon D - YYYY` (e.g., `Jul 1 - 2024`)

**DR values:** Numbers 0-100, or empty for no data

**Example row:**
```
1,decoratoradvice.com,57,,72,72,56,71,71,71,...
```

### Adding New Data

**To add new dates:**
1. For traffic-data.csv and DR History.csv: Add new date column to the right
2. For revenue-history.csv: Add new month column to the right (before Total/Count)
3. For ahrefs_organic_traffic_results.csv: Append new rows at the bottom

**Common issues:**
- Ensure domain names match exactly across all files (case-sensitive)
- Don't change column order for existing columns
- Keep date formats consistent within each file
- Revenue must include `$` symbol and commas for thousands

---

## Tech Stack

| Component | Technology |
|-----------|------------|
| Frontend | Vanilla HTML/CSS/JavaScript (ES6+) |
| Charts | ApexCharts (CDN) |
| CSV Parsing | PapaParse 5.4.1 |
| Fonts | Inter (Google Fonts) |
| Hosting | Vercel (auto-deploy from GitHub) |

---

## Styling Conventions

- Primary color (orange): #f97316
- Positive/success (green): #10b981, #4ade80
- Negative (red): #f87171
- Neutral (yellow): #fbbf24
- Chart colors: Orange (internal), Blue (ahrefs), Green (revenue), Purple (DR)
- Font: Inter
- Border radius: 12px for cards, 8px for inputs
- Percentages: 2 decimal places for revenue stats

---

## Things That Didn't Work / Lessons Learned

> **IMPORTANT:** Document ALL failed approaches here with reasons. This prevents going in circles.

### Chart Libraries
- **Chart.js**: Initially used but replaced with ApexCharts for better customization, zoom/pan, and multiple y-axes support
- **Plotly**: Initial version (dark theme) - replaced with ApexCharts for lighter weight and better UX

### Revenue Display
- **Revenue as line chart**: Didn't convey monthly totals well. Switched to stepped area bars (day 1-25 with gap at day 26-27) which clearly shows monthly blocks
- **Hiding $0 revenue months**: Created gaps in chart. Must include $0 months to maintain continuity
- **Hiding $0 in tooltip**: Confusing when revenue bar shows but tooltip doesn't mention it. Show "Revenue: $0" explicitly

### Data Handling
- **Hardcoded domain lists only**: Limited flexibility. Now dynamically load all domains from CSV and filter by revenue > $0.01

### Layout
- **Date selector centered above chart**: User preferred it in original position (right side of chart header). Reverted.

### Annotations
- **ApexCharts point annotations for revenue labels**: Works well but needs toggle since it can clutter the chart

### Tooltip
- **Smooth day-by-day tooltip following cursor X position**: Added then reverted. Caused issues - tooltip needs to snap to actual data points, not interpolate between them

### DR (Domain Rating) Display - Multiple Iterations
- **DR as 4th series on main chart (first attempt)**: Added but cluttered the chart
- **DR in separate stat card with sparkline**: Moved DR off chart into its own card. Removed later - redundant since DR visible on chart
- **Custom legend for DR**: Tried custom legend component. Removed - ApexCharts built-in clickable legend works better
- **WINNER: DR as purple dotted line on chart**: Dotted style distinguishes it from traffic lines, separate right y-axis (0-100 scale)

### Toggle Implementation
- **Toggle in chart legend area**: Tried moving revenue label toggle into legend. Harder to find
- **WINNER: Slider toggle in header**: More visible, clear on/off state

### Chart Styling
- **Area fill on traffic lines (Our Data, Ahrefs)**: Made chart look heavy/cluttered. Removed fills, kept as clean lines. Only Revenue keeps subtle 25% opacity fill

### Traffic-Revenue Correlation Methods (from earlier analysis)
- **Same-Month Latest (last snapshot only)**: Correlation 0.48 - noisy, doesn't smooth out daily fluctuations
- **30-Day Lagged traffic**: Correlation 0.50 - not as good as same-month
- **60-Day Lagged traffic**: Correlation 0.47 - worse than other methods
- **WINNER: Same-Month Average**: Correlation 0.58 - averaging all snapshots within the month smooths noise and gives best correlation

### Stability Calculation (from earlier analysis)
- **CV from all raw traffic snapshots**: Measures snapshot-to-snapshot noise, not meaningful month-to-month stability
- **WINNER: CV from same-month averages**: Aligns with how revenue is recorded (monthly), captures actual month-over-month volatility

### Traffic Band Analysis (from earlier analysis)
- **Site-level bands (overall average per site)**: Doesn't show direct traffic→revenue relationship
- **WINNER: Month-level bands (each site-month is separate)**: Shows "when a site has X traffic in a given month, how much revenue does it typically make?"

### Revenue Label Positioning
- **Position at actual revenue value (y: ann.y)**: Low revenue months had labels below x-axis
- **Fixed pixel offset (offsetY: 25)**: Inconsistent positioning at different revenue scales
- **WINNER: Uniform Y position (maxRevenue * 0.025)**: All labels at same height near bottom of bars

### X-Axis Month Labels
- **Default datetime axis labels**: Position at tick marks (1st of month), not centered on revenue bars
- **offsetX pixel nudge**: Only works at one zoom level, breaks at others
- **WINNER: Xaxis annotations at day 13**: Centered on revenue bars (days 1-25), consistent at all zoom levels

### January Highlighting
- **Orange color + bold + larger font**: Too visually heavy
- **WINNER: Bold font only**: Subtle but clear year boundary marker

---

## File Structure

```
traffic-dashboard/
├── index-apex.html          # Main dashboard (ApexCharts - production)
├── leaderboard.html         # Revenue leaderboard page
├── index.html               # Legacy Chart.js version (deprecated)
├── index-apex-annotations.html  # Experimental annotations version
├── api/
│   └── auth/
│       ├── login.js         # Redirects to Google OAuth
│       ├── callback.js      # Handles OAuth callback, validates email
│       ├── logout.js        # Clears session cookie
│       ├── me.js            # Returns current user info
│       └── check.js         # Returns auth status for client-side check
├── vercel.json              # Vercel deployment config + headers
├── robots.txt               # Blocks search engine crawlers
├── .cursorrules             # This file - KEEP UPDATED
├── .gitignore               # Git ignore rules
│
├── # Data Files
├── traffic-data.csv         # Internal traffic data
├── revenue-history.csv      # Monthly revenue by domain
├── ahrefs_organic_traffic_results.csv  # Ahrefs organic traffic
├── DR History.csv           # Domain Rating history
├── ahrefs-data.csv          # Legacy (deprecated)
│
├── # Documentation
├── README.md                # Setup instructions
└── PRD.md                   # Product requirements document
```

---

## Update Instructions

**CRITICAL: When making ANY changes to this project, update this file:**

1. Add new features to "Current Features" section with [x] checkbox
2. Document EVERY failed approach in "Things That Didn't Work" with:
   - What was tried
   - Why it didn't work
   - What solution was used instead
3. Keep file structure current
4. Add new data sources if added

---

## Common Tasks

### Add a new data series to chart
1. Load data in `loadDataFromCSV()` or create new loader function
2. Add to domain object in the merge loop
3. Add series config in `createChart()` options
4. Add y-axis config if needed
5. Update tooltip custom function
6. Update legend colors array

### Change time periods for rankings
- Modify `currentMonth` and `last3Months` variables in `calculateRevenueRankings()`
- Same in leaderboard.html `loadRevenueCSV()`

### Local development
```bash
python3 -m http.server 8000
# Open http://localhost:8000/index-apex.html
```
Note: Opening HTML directly via `file://` won't load CSVs (browser security). Use local server.
Note: Auth only works in production (Vercel). Local dev bypasses auth.

### Manage allowed users
Update `ALLOWED_EMAILS` env var in Vercel dashboard (comma-separated list).
No redeploy needed - changes take effect immediately.

### Required Vercel Environment Variables
| Variable | Description |
|----------|-------------|
| `GOOGLE_CLIENT_ID` | From Google Cloud Console OAuth credentials |
| `GOOGLE_CLIENT_SECRET` | From Google Cloud Console OAuth credentials |
| `SESSION_SECRET` | Random 32+ char string for signing cookies |
| `ALLOWED_EMAILS` | Comma-separated list of approved emails |

---

## Troubleshooting Guide

> Quick fixes for common issues. Copy-paste these into Cursor if you need help.

### Dashboard won't load / blank page
**Symptoms:** White screen, nothing displays
**Causes & Fixes:**
1. **Check browser console** (F12 → Console tab) for red errors
2. **CSV file missing or renamed** - Ensure all 4 CSVs exist with exact names
3. **CSV parsing error** - Check for malformed rows (unbalanced quotes, wrong comma count)
4. **CDN down** - ApexCharts or PapaParse CDN unavailable (rare). Replace CDN URLs in HTML.

### Chart shows "No data" or empty
**Symptoms:** Chart renders but no lines/bars
**Fixes:**
1. Domain name in dropdown doesn't match CSV exactly (case-sensitive!)
2. Date columns changed format - must be `Mon D - YYYY` for traffic/DR
3. All traffic values are empty/null for that domain

### Authentication not working
**Symptoms:** Redirects to login forever, "Access Denied" for valid emails
**Fixes:**
1. Check Vercel Environment Variables are set correctly
2. `ALLOWED_EMAILS` must be comma-separated, no spaces: `user1@gmail.com,user2@gmail.com`
3. Google OAuth credentials expired - regenerate in Google Cloud Console
4. Session cookie issues - clear browser cookies, try incognito

### Revenue not showing for a domain
**Symptoms:** Domain appears but revenue bubbles show $0
**Fixes:**
1. Domain name in revenue-history.csv must match traffic-data.csv exactly
2. Revenue values must include `$` symbol
3. Check the domain row exists in revenue-history.csv

### Vercel deployment failed
**Symptoms:** Push succeeded but site shows old version or errors
**Fixes:**
1. Check Vercel dashboard for build errors
2. Verify all files committed (`git status` shows clean)
3. Check vercel.json syntax is valid JSON

### Local development not loading CSVs
**Symptoms:** Works on Vercel but not locally
**Fix:** Must use local server, not `file://` protocol:
```bash
cd traffic-dashboard
python3 -m http.server 8000
# Open http://localhost:8000/index-apex.html
```

---

## Pending / Future Features

### High Priority
- [ ] **Automated daily data updates** - Currently manual CSV updates. Options discussed:
  - **Option A: Airtable backend** - Store data in Airtable, dashboard fetches via Airtable API. Pros: easy to edit, no code to update data. Cons: API rate limits, potential cost at scale.
  - **Option B: S3 + scheduled task** - CSVs stored in S3 bucket, scheduled Lambda/script updates them daily, dashboard fetches from S3. Pros: scalable, cheap. Cons: more setup, need AWS account.
  - **Option C: GitHub Actions** - Scheduled workflow commits updated CSVs to repo daily. Pros: no extra services. Cons: need script to generate/fetch new data.
  - **Decision needed:** Where does the source data come from? (Google Sheets? Database? API?)
- [ ] **Staged CSV loading** - Load top 100 revenue domains first for fast initial render, then load rest in background. Options: (A) pre-split CSVs, (B) streaming parse, (C) sort CSVs by revenue rank + preview mode
- [ ] **Sales manager assignment** - Add "Sales Manager" column to revenue-history.csv (e.g., "Rina", "Jack", etc.)
- [ ] **Sales manager filter view** - Filter dashboard/leaderboard to show only sites owned by a specific sales manager. Could be dropdown filter or separate page like leaderboard


---

## Session Log

> Track significant changes made during Cursor sessions here.

| Date | Change | Notes |
|------|--------|-------|
| Jan 14, 2026 | Initial commit | Plotly dark theme |
| Jan 20, 2026 | CSV integration | Load traffic, revenue, Ahrefs from CSV files |
| Jan 20, 2026 | ApexCharts migration | Replaced Plotly - better zoom/pan, multiple y-axes |
| Jan 20, 2026 | Revenue axis scaling | Bottom-third display, stepped area bars |
| Jan 20, 2026 | DR series iterations | Tried stat card → removed → back on chart as dotted line |
| Jan 20, 2026 | Revenue labels toggle | Slider in header, annotations approach |
| Jan 20, 2026 | Default view Dec 2024 | Added "From Dec 2024" date option |
| Jan 20, 2026 | 100 domains support | Searchable dropdown with keyboard nav |
| Jan 21, 2026 | Dropdown UX | Select all on focus, show full list on click |
| Jan 21, 2026 | Zoom-out bug fix | Use xaxis min/max instead of data filtering |
| Jan 21, 2026 | Revenue ranking bubbles | Lifetime, L3M, Current Month with % of portfolio |
| Jan 21, 2026 | Leaderboard page | All domains with revenue > $0.01, 3 tabs |
| Jan 21, 2026 | Layout fixes | Restored date selector position, aligned nav |
| Jan 21, 2026 | Revenue % precision | Changed to 2 decimal places |
| Jan 23, 2026 | Enhanced .cursorrules | Full lessons learned from git history |
| Jan 23, 2026 | Search engine blocking | robots.txt, meta tags, X-Robots-Tag header |
| Jan 23, 2026 | Google OAuth auth | Serverless API + client-side check, email allowlist, 24hr sessions |
| Jan 23, 2026 | Revenue label positioning | Fixed uniform height near x-axis (was varying with bar height) |
| Jan 23, 2026 | Centered month labels | Xaxis annotations at day 13 of each month, replacing auto datetime labels |
| Jan 23, 2026 | January label highlighting | Bold font weight for Jan labels to mark year boundaries |
| Jan 24, 2026 | Dynamic month calculations | Last 3 Months now uses complete calendar months only, auto-updates |
| Jan 24, 2026 | Rank change tracker | Sites by Agent Current Month tab shows position changes vs previous month |
| Jan 24, 2026 | Avg Last 3 Months bubble | New metric on main dashboard showing average monthly revenue |

---

*Last updated: January 24, 2026 - Dynamic month calculations and rank tracker feature*
