# Traffic Dashboard - Cursor Rules

## Project Overview

A traffic comparison dashboard showing internal traffic data vs Ahrefs data, with revenue tracking and DR (Domain Rating) history. Built with ApexCharts for visualization.

**Live URL:** https://traffic-dashboard-theta.vercel.app/
**Main Dashboard:** /index-apex.html
**Leaderboard:** /leaderboard.html
**Repository:** https://github.com/romesfallen/traffic-dashboard.git
**Branch:** master

---

## CRITICAL: Cursor Workflow Best Practices

> **Follow these practices for EVERY significant task.**

### 1. ALWAYS Use Plan Mode First

For any non-trivial task, **start in Plan Mode** before making changes:

1. **Switch to Plan Mode** before implementing
2. **Discuss the approach** - outline what will be changed
3. **Get approval** on the plan before writing code
4. **Then switch to Agent Mode** to implement

**When to use Plan Mode:**
- Adding new features
- Refactoring existing code
- Fixing complex bugs
- Any change touching multiple files

**Exceptions (can skip Plan Mode):**
- Simple typo fixes
- Single-line changes
- Adding console.log for debugging

### 2. Debugging - Add Extensive Logging

When troubleshooting issues:

1. **Add console.log statements liberally** at every step
2. **Deploy to production** if needed (some issues only appear with live data)
3. **Check browser console** for the debug output
4. **Fix the root cause** once identified
5. **Remove debug logging** before final commit

See "Debugging Guidelines" section below for patterns.

### 3. Testing - Cover All Combinations

Every feature needs E2E tests that cover:

1. **Feature existence** - element appears on page
2. **Feature functionality** - interactions work correctly
3. **Feature combinations** - works with other features on/off
4. **Data validation** - real data displays correctly
5. **Regression prevention** - critical elements don't disappear

See "New Features Must Have Tests" section below.

### 4. Push Testing - Verify Deployment

After every push:

1. **Wait for Vercel deployment** (~1-2 minutes)
2. **Run production tests:**
   ```bash
   E2E_TEST_TOKEN=<token> npm run test:e2e:prod
   ```
3. **Check for missing files** - API endpoints not committed is a common issue
4. **Verify in browser** - manually check critical features work

### 5. Keep This File Updated

After completing any task:

1. **Add new features** to "Current Features" section
2. **Document failures** in "Things That Didn't Work" section
3. **Update Session Log** with date and changes
4. **Add new data sources** to Data Architecture if applicable

---

## CRITICAL: Pre-Change Checklist (MUST FOLLOW)

> **This checklist prevents accidental feature removal. Follow EVERY time before making changes.**

### BEFORE Making Any Edit

1. **Check for untracked files that should be committed:**
   ```bash
   git status
   ```
   - Look for API files in `api/data/` that are untracked
   - Look for test files that haven't been committed
   - **If files are untracked but needed for features, commit them FIRST**

2. **Understand what the file currently does:**
   - Read the file (or relevant sections)
   - List the features it provides
   - Note all CSS classes, IDs, and function names used by other files

3. **Check if the feature has tests:**
   - Search in `tests/` folder for related test coverage
   - If no tests exist, consider adding them FIRST

### AFTER Making Changes

4. **Verify no features were removed:**
   ```bash
   git diff HEAD -- <filename>
   ```
   - Check lines starting with `-` (deletions)
   - Ask: "Was this deletion intentional?"
   - Look for removed functions, CSS classes, HTML elements

5. **Check for new untracked files:**
   ```bash
   git status
   ```
   - Any new API endpoints created? They need to be committed!
   - Any new test files? Commit them!

6. **Run tests if available:**
   ```bash
   npx playwright test
   ```

### BEFORE Committing

7. **Review the full diff:**
   ```bash
   git diff --staged
   ```
   - Ensure only intended changes are included
   - Check for accidentally removed code

8. **Check all API endpoints are committed:**
   ```bash
   ls api/data/
   git status api/data/
   ```
   - Every `.js` file in `api/data/` should be tracked

### Common Mistakes to Avoid

| Mistake | Prevention |
|---------|------------|
| Feature removed in edit | Always `git diff` before commit |
| New API file not committed | Always `git status` to check untracked files |
| Test using wrong selector | Verify selectors match actual HTML IDs/classes |
| CSV parsing uses wrong column | Check actual CSV structure before writing parser |

---

## CRITICAL: New Features Must Have Tests

> **Every new feature MUST have corresponding E2E tests before being considered complete.**

### When Adding a New Feature

1. **Write tests FIRST or IMMEDIATELY after** implementing the feature
2. **Test location:** `tests/e2e/` directory
3. **Test types to include:**
   - Feature existence test (element exists on page)
   - Feature functionality test (clicking/interacting works)
   - Data validation test (if feature displays data)
   - Regression test in `regression-prevention.spec.js` for critical features

### Test File Structure

| Feature Type | Where to Add Tests |
|--------------|-------------------|
| New UI element | `feature-combinations.spec.js` or new spec file |
| New API endpoint | `data-validation.spec.js` |
| Critical feature | `regression-prevention.spec.js` |
| Navigation change | `navigation.spec.js` |

### Example: Adding a New Toggle

```javascript
// In feature-combinations.spec.js or filters.spec.js
test.describe('New Feature Toggle', () => {
  test('toggle exists and is visible', async ({ page }) => {
    await page.goto(DASHBOARD_URL);
    await expect(page.locator('#newFeatureToggle')).toBeVisible();
  });
  
  test('clicking toggle changes state', async ({ page }) => {
    await page.goto(DASHBOARD_URL);
    const toggle = page.locator('#newFeatureToggle');
    await toggle.click();
    await expect(toggle).not.toBeChecked();
  });
});
```

### Running Tests

```bash
# Run all tests locally
npm run test:e2e

# Run tests against production (requires E2E_TEST_TOKEN)
E2E_TEST_TOKEN=<token> npm run test:e2e:prod

# Run specific test file
npx playwright test tests/e2e/filters.spec.js
```

### E2E Test Token (for production tests)

Production tests require the `E2E_TEST_TOKEN` environment variable to bypass Google OAuth.
- Token is stored in Vercel environment variables (marked as Sensitive)
- Also in GitHub Secrets for CI/CD
- Never commit the token to code

---

## Deployment Instructions

When asked to "push", "deploy", "push live", or "push to Vercel":

1. **Follow Pre-Change Checklist above FIRST**
2. Check git status for changes AND untracked files
3. Stage relevant files with `git add` (including any untracked API files!)
4. Commit with descriptive message using HEREDOC format:
   ```bash
   git commit -m "$(cat <<'EOF'
   Commit title here
   
   - Bullet point details
   EOF
   )"
   ```
5. Push to origin master: `git push origin master`
6. Vercel auto-deploys from GitHub
7. **WAIT for deployment to complete** (~1-2 minutes)
8. **Run production tests to verify deployment:**
   ```bash
   npm run test:e2e:prod
   ```
   - This runs tests against the LIVE production site
   - Catches issues like missing API files, broken features
   - If tests fail, investigate and fix before considering deployment complete
9. Provide URL: https://traffic-dashboard-theta.vercel.app/

### Automated CI Testing

GitHub Actions runs E2E tests automatically on every push to master:
- Tests run BEFORE Vercel deploys
- If tests fail, check the Actions tab on GitHub for details
- Fix failing tests before pushing again

---

## Data Architecture (CRITICAL)

> **ALL DATA IS HOSTED ON AWS S3** - There are NO local CSV files in this project.

### Data Flow
```
Google Sheets â†’ Lambda (every 15 min) â†’ S3 Bucket â†’ Vercel API â†’ Dashboard
```

### S3 Bucket: `traffic-dashboard-theta`
| S3 File | API Endpoint | Sync Frequency |
|---------|--------------|----------------|
| `traffic-data.csv` | `/api/data/traffic` | Every 15 min (Lambda) |
| `traffic-data-priority.csv` | `/api/data/traffic-priority` | Every 15 min (Lambda) |
| `revenue-history.csv` | `/api/data/revenue` | Every 15 min (Lambda) |
| `DR History.csv` | `/api/data/dr` | Every 15 min (Lambda) |
| `DR History-priority.csv` | `/api/data/dr-priority` | Every 15 min (Lambda) |
| `internal-average-traffic.csv` | `/api/data/average` | Every 15 min (Lambda) |
| `site-agent-niche.csv` | `/api/data/agent-niche` | Manual upload (~monthly) |
| `sync-log.json` | `/api/data/sync-status` | Every 15 min (Lambda) |

### NEVER use local CSV files
- All `fetch()` calls MUST use `/api/data/*` endpoints
- Local CSV files were deleted to prevent stale data issues
- If you see `fetch('*.csv')` without `/api/data/`, it's a BUG

### Revenue "Current" Column
- Google Sheet uses "Current" header for current month (not "Jan 2026")
- Frontend dynamically maps "Current" â†’ current month key (e.g., "Jan2026")
- This happens automatically based on system date

---

## Debugging Guidelines

> **When encountering data issues, ADD EXTENSIVE CONSOLE LOGGING FIRST**

### Standard Debugging Process
1. **Add console.log statements** at key data processing points
2. **Deploy to production** (debugging often requires live S3 data)
3. **Check browser console** for the debug output
4. **Identify the issue** from the logs
5. **Fix the root cause**
6. **Remove debug logging** before final commit

### Recommended Debug Points
- After fetching CSV: log row count, column count, sample data
- During data parsing: log parsed values, date formats
- Before chart rendering: log data points, date ranges
- For specific domains: add conditional logging (e.g., `if (domain === 'betterthisworld.com')`)

### Example Debug Pattern
```javascript
console.log('ðŸ” DEBUG [SECTION]:', {
    totalRows: data.length,
    sampleRow: data[0],
    expectedValue: someVar,
    actualValue: otherVar
});
```

### Debug Logging Rules
- Use emoji prefixes for visibility: ðŸ” DEBUG, âœ… SUCCESS, âŒ ERROR
- Always remove debug logs after issue is resolved
- Never commit extensive debug logging to production permanently

---

## Current Features

### Search Engine Protection
- [x] robots.txt blocking all crawlers
- [x] Meta robots tags (noindex, nofollow, noarchive, nosnippet) on all pages
- [x] X-Robots-Tag HTTP header via vercel.json

### Authentication (Google OAuth)
- [x] Client-side auth check redirects to login if not authenticated
- [x] Google OAuth login flow via /api/auth endpoints
- [x] Email allowlist validation (ALLOWED_EMAILS env var)
- [x] 24-hour session cookies (HttpOnly, Secure)
- [x] User bar showing logged-in email with Sign Out button
- [x] Access denied page for non-approved emails
- [x] Page hidden until auth verified (prevents flash of content)

### Main Dashboard (index-apex.html)
- [x] ApexCharts line/area chart with traffic data
- [x] Dual traffic series: Internal Monthly Traffic vs Ahrefs Monthly Traffic
- [x] Revenue bars (stepped area, bottom-third of chart)
- [x] Revenue labels with toggle on/off
- [x] DR (Domain Rating) line with dotted style
- [x] Date range selector (7d, 30d, 90d, 6mo, 1yr, From Dec 2024, All time)
- [x] Searchable domain dropdown with keyboard navigation
- [x] Linear interpolation for missing data points
- [x] Zoom and pan functionality
- [x] Custom tooltip showing all series values
- [x] Revenue ranking bubbles above chart showing:
  - Lifetime Revenue rank, value, % of portfolio
  - Last 3 Months rank, value, % of portfolio (uses 3 complete calendar months, excludes current incomplete month)
  - Current Month rank, value, % of portfolio
  - Avg Last 3 Months value (no rank, no percentage)
- [x] Dynamic month calculations based on current date (auto-updates each month)
- [x] Centered domain title above ranking bubbles
- [x] URL parameter support (?domain=example.com)
- [x] Navigation link to Leaderboard

### Leaderboard (leaderboard.html)
- [x] Shows ALL domains with revenue > $0.01
- [x] Three tabs: Lifetime / Last 3 Months / Current Month
- [x] Sortable table columns: Rank, Change, Domain, Agent, Revenue, % of Portfolio
- [x] Portfolio total displayed
- [x] Site count in subtitle
- [x] Clickable domains link to dashboard with pre-selected domain
- [x] Back to Dashboard link
- [x] Dynamic month calculations (Last 3 Months uses complete calendar months only)
- [x] Rank change column on Current Month tab (separate sortable column)
- [x] Filter panel on Current Month tab:
  - Rank (min/max range)
  - Change (Up only, Down only, New only, Unchanged)
  - Revenue (min/max range)
  - Agent (dropdown)
  - % of Portfolio (min/max range)
  - Filters are combinable
  - Active filter count badge
  - Clear All button
- [x] Table max-width 1100px for better domain/icon fit

### Sites by Agent (agent.html)
- [x] Agent selector buttons (dynamically loaded from CSV)
- [x] Three tabs: Lifetime / Last 3 Months / Current Month
- [x] Sortable table columns: Rank, Change, Domain, Niche, Revenue, % of Portfolio
- [x] Agent portfolio total displayed
- [x] Ahrefs links and copy domain buttons
- [x] Clickable domains link to main dashboard
- [x] Clickable niches link to niche.html
- [x] Dynamic month calculations (Last 3 Months uses complete calendar months only)
- [x] Rank change column on Current Month tab (separate sortable column):
  - Shows position change vs previous complete month
  - Green up arrow (â–²) with +N for improvements
  - Red down arrow (â–¼) with -N for declines
  - Star (â˜…) with "new" for sites new to the rankings
- [x] Filter panel on Current Month tab:
  - Rank (min/max range)
  - Change (Up only, Down only, New only, Unchanged)
  - Revenue (min/max range)
  - % of Portfolio (min/max range)
  - Filters are combinable
  - Active filter count badge
  - Clear All button
- [x] Table max-width 1100px for better domain/icon fit

### Sites by Niche (niche.html)
- [x] Similar structure to agent.html but filtered by niche
- [x] Dynamic month calculations (Last 3 Months uses complete calendar months only)

### Data Sources
> See **Data Architecture** section above for complete S3/API mapping.
- Ahrefs Monthly/Average Traffic - TEMPORARILY DISABLED (new methodology pending, UI infrastructure kept)

---

## CSV Format Specifications

> **CRITICAL:** If updating CSVs, maintain these exact formats. The dashboard will break if column names or structure changes.

### 1. traffic-data.csv (Internal Traffic)

**Format:** Wide format with dates as columns

| Column | Description | Example |
|--------|-------------|---------|
| (empty) | Row number (auto-generated) | `1` |
| Website | Domain name | `decoratoradvice.com` |
| Ahrefs Links | Link to Ahrefs for this domain | `https://app.ahrefs.com/...` |
| Link Working | Status field (optional) | - |
| Type | Category type | `Sales` |
| Original Type | Original category (optional) | - |
| `Mon D - YYYY` | Traffic value for that date | `16495` or `"54,316"` |

**Date column format:** `Mon D - YYYY` (e.g., `Jul 1 - 2024`, `Jan 15 - 2025`)

**Traffic values:** Can be plain numbers (`16495`) or comma-formatted strings (`"54,316"`)

**Example row:**
```
1,decoratoradvice.com,https://app.ahrefs.com/...,Sales,,,,11209,16495,16572,...
```

### 2. revenue-history.csv (Monthly Revenue)

**Format:** Wide format with months as columns

| Column | Description | Example |
|--------|-------------|---------|
| (header row 1) | Snapshot date | `1/19/26` |
| Purchase Price | Cost to acquire | `$1,500.00` |
| Live Date | When site went live | `Jan 2022 or earlier` |
| Website | Domain name | `betterthisworld.com` |
| Niche | Site category/niche | `General, Health, Business` |
| `Mon YYYY` | Revenue for that month | `$375.00` or `-` |
| Total | Lifetime revenue sum | `$610,244.64` |
| Count | Number of months with revenue | `49` |

**Month column format:** `Mon YYYY` (e.g., `Jan 2022`, `Dec 2025`)

**Revenue values:** 
- Dollar amounts with `$` and commas: `$1,500.00`, `$10,954.50`
- `-` for no data/not applicable
- Empty for no revenue that month

**Example row:**
```
Bought - Mohit,"$1,500.00",Jan 2022 or earlier,betterthisworld.com,"General, Health, Business",$375.00,$630.00,...,$610,244.64,49
```

### 3. ahrefs_organic_traffic_results.csv (Ahrefs Traffic)

**Format:** Long/tidy format (one row per domain per date)

| Column | Description | Example |
|--------|-------------|---------|
| domain | Domain name | `lyncconf.com` |
| date | ISO 8601 date | `2024-01-01T00:00:00Z` |
| organic_traffic | Traffic value (integer) | `2024` |

**Date format:** ISO 8601 with timezone: `YYYY-MM-DDTHH:MM:SSZ`

**Example rows:**
```
domain,date,organic_traffic
lyncconf.com,2024-01-01T00:00:00Z,2024
lyncconf.com,2024-01-02T00:00:00Z,1980
```

### 4. DR History.csv (Domain Rating)

**Format:** Wide format with dates as columns (same structure as traffic-data.csv)

| Column | Description | Example |
|--------|-------------|---------|
| (empty) | Row number | `1` |
| Website | Domain name | `decoratoradvice.com` |
| `Mon D - YYYY` | DR value for that date (0-100) | `57`, `72`, or empty |

**Date column format:** `Mon D - YYYY` (e.g., `Jul 1 - 2024`)

**DR values:** Numbers 0-100, or empty for no data

**Example row:**
```
1,decoratoradvice.com,57,,72,72,56,71,71,71,...
```

### Adding New Data

**To add new dates:**
1. For traffic-data.csv and DR History.csv: Add new date column to the right
2. For revenue-history.csv: Add new month column to the right (before Total/Count)
3. For ahrefs_organic_traffic_results.csv: Append new rows at the bottom

**Common issues:**
- Ensure domain names match exactly across all files (case-sensitive)
- Don't change column order for existing columns
- Keep date formats consistent within each file
- Revenue must include `$` symbol and commas for thousands

---

## Tech Stack

| Component | Technology |
|-----------|------------|
| Frontend | Vanilla HTML/CSS/JavaScript (ES6+) |
| Charts | ApexCharts (CDN) |
| CSV Parsing | PapaParse 5.4.1 |
| Fonts | Inter (Google Fonts) |
| Hosting | Vercel (auto-deploy from GitHub) |

---

## Styling Conventions

- Primary color (orange): #f97316
- Positive/success (green): #10b981, #4ade80
- Negative (red): #f87171
- Neutral (yellow): #fbbf24
- Chart colors: Orange (internal), Blue (ahrefs), Green (revenue), Purple (DR)
- Font: Inter
- Border radius: 12px for cards, 8px for inputs
- Percentages: 2 decimal places for revenue stats

---

## Things That Didn't Work / Lessons Learned

> **IMPORTANT:** Document ALL failed approaches here with reasons. This prevents going in circles.

### Chart Libraries
- **Chart.js**: Initially used but replaced with ApexCharts for better customization, zoom/pan, and multiple y-axes support
- **Plotly**: Initial version (dark theme) - replaced with ApexCharts for lighter weight and better UX

### Revenue Display
- **Revenue as line chart**: Didn't convey monthly totals well. Switched to stepped area bars (day 1-25 with gap at day 26-27) which clearly shows monthly blocks
- **Hiding $0 revenue months**: Created gaps in chart. Must include $0 months to maintain continuity
- **Hiding $0 in tooltip**: Confusing when revenue bar shows but tooltip doesn't mention it. Show "Revenue: $0" explicitly

### Data Handling
- **Hardcoded domain lists only**: Limited flexibility. Now dynamically load all domains from CSV and filter by revenue > $0.01

### Layout
- **Date selector centered above chart**: User preferred it in original position (right side of chart header). Reverted.

### Annotations
- **ApexCharts point annotations for revenue labels**: Works well but needs toggle since it can clutter the chart

### Tooltip
- **Smooth day-by-day tooltip following cursor X position**: Added then reverted. Caused issues - tooltip needs to snap to actual data points, not interpolate between them

### DR (Domain Rating) Display - Multiple Iterations
- **DR as 4th series on main chart (first attempt)**: Added but cluttered the chart
- **DR in separate stat card with sparkline**: Moved DR off chart into its own card. Removed later - redundant since DR visible on chart
- **Custom legend for DR**: Tried custom legend component. Removed - ApexCharts built-in clickable legend works better
- **WINNER: DR as purple dotted line on chart**: Dotted style distinguishes it from traffic lines, separate right y-axis (0-100 scale)

### Toggle Implementation
- **Toggle in chart legend area**: Tried moving revenue label toggle into legend. Harder to find
- **WINNER: Slider toggle in header**: More visible, clear on/off state

### Chart Styling
- **Area fill on traffic lines (Our Data, Ahrefs)**: Made chart look heavy/cluttered. Removed fills, kept as clean lines. Only Revenue keeps subtle 25% opacity fill

### Traffic-Revenue Correlation Methods (from earlier analysis)
- **Same-Month Latest (last snapshot only)**: Correlation 0.48 - noisy, doesn't smooth out daily fluctuations
- **30-Day Lagged traffic**: Correlation 0.50 - not as good as same-month
- **60-Day Lagged traffic**: Correlation 0.47 - worse than other methods
- **WINNER: Same-Month Average**: Correlation 0.58 - averaging all snapshots within the month smooths noise and gives best correlation

### Stability Calculation (from earlier analysis)
- **CV from all raw traffic snapshots**: Measures snapshot-to-snapshot noise, not meaningful month-to-month stability
- **WINNER: CV from same-month averages**: Aligns with how revenue is recorded (monthly), captures actual month-over-month volatility

### Traffic Band Analysis (from earlier analysis)
- **Site-level bands (overall average per site)**: Doesn't show direct trafficâ†’revenue relationship
- **WINNER: Month-level bands (each site-month is separate)**: Shows "when a site has X traffic in a given month, how much revenue does it typically make?"

### Revenue Label Positioning
- **Position at actual revenue value (y: ann.y)**: Low revenue months had labels below x-axis
- **Fixed pixel offset (offsetY: 25)**: Inconsistent positioning at different revenue scales
- **WINNER: Uniform Y position (maxRevenue * 0.025)**: All labels at same height near bottom of bars

### X-Axis Month Labels
- **Default datetime axis labels**: Position at tick marks (1st of month), not centered on revenue bars
- **offsetX pixel nudge**: Only works at one zoom level, breaks at others
- **WINNER: Xaxis annotations at day 13**: Centered on revenue bars (days 1-25), consistent at all zoom levels

### January Highlighting
- **Orange color + bold + larger font**: Too visually heavy
- **WINNER: Bold font only**: Subtle but clear year boundary marker

---

## File Structure

```
traffic-dashboard/
â”œâ”€â”€ index-apex.html          # Main dashboard (ApexCharts - production)
â”œâ”€â”€ leaderboard.html         # Revenue leaderboard page
â”œâ”€â”€ index.html               # Legacy Chart.js version (deprecated)
â”œâ”€â”€ index-apex-annotations.html  # Experimental annotations version
â”œâ”€â”€ api/
â”‚   â””â”€â”€ auth/
â”‚       â”œâ”€â”€ login.js         # Redirects to Google OAuth
â”‚       â”œâ”€â”€ callback.js      # Handles OAuth callback, validates email
â”‚       â”œâ”€â”€ logout.js        # Clears session cookie
â”‚       â”œâ”€â”€ me.js            # Returns current user info
â”‚       â””â”€â”€ check.js         # Returns auth status for client-side check
â”œâ”€â”€ vercel.json              # Vercel deployment config + headers
â”œâ”€â”€ robots.txt               # Blocks search engine crawlers
â”œâ”€â”€ .cursorrules             # This file - KEEP UPDATED
â”œâ”€â”€ .gitignore               # Git ignore rules
â”‚
â”œâ”€â”€ # Data Files (all now served from S3 via /api/data/* endpoints)
â”œâ”€â”€ # Local CSVs removed - data fetched from S3 to prevent stale data issues
â”‚
â”œâ”€â”€ # Documentation
â”œâ”€â”€ README.md                # Setup instructions
â””â”€â”€ PRD.md                   # Product requirements document
```

---

## Update Instructions

**CRITICAL: When making ANY changes to this project, update this file:**

1. Add new features to "Current Features" section with [x] checkbox
2. Document EVERY failed approach in "Things That Didn't Work" with:
   - What was tried
   - Why it didn't work
   - What solution was used instead
3. Keep file structure current
4. Add new data sources if added

---

## Common Tasks

### Add a new data series to chart
1. Load data in `loadDataFromCSV()` or create new loader function
2. Add to domain object in the merge loop
3. Add series config in `createChart()` options
4. Add y-axis config if needed
5. Update tooltip custom function
6. Update legend colors array

### Change time periods for rankings
- Modify `currentMonth` and `last3Months` variables in `calculateRevenueRankings()`
- Same in leaderboard.html `loadRevenueCSV()`

### Local development
```bash
python3 -m http.server 8000
# Open http://localhost:8000/index-apex.html
```
Note: Opening HTML directly via `file://` won't load CSVs (browser security). Use local server.
Note: Auth only works in production (Vercel). Local dev bypasses auth.

### Manage allowed users
Update `ALLOWED_EMAILS` env var in Vercel dashboard (comma-separated list).
No redeploy needed - changes take effect immediately.

### Required Vercel Environment Variables
| Variable | Description |
|----------|-------------|
| `GOOGLE_CLIENT_ID` | From Google Cloud Console OAuth credentials |
| `GOOGLE_CLIENT_SECRET` | From Google Cloud Console OAuth credentials |
| `SESSION_SECRET` | Random 32+ char string for signing cookies |
| `ALLOWED_EMAILS` | Comma-separated list of approved emails |

---

## Troubleshooting Guide

> Quick fixes for common issues. Copy-paste these into Cursor if you need help.

### Dashboard won't load / blank page
**Symptoms:** White screen, nothing displays
**Causes & Fixes:**
1. **Check browser console** (F12 â†’ Console tab) for red errors
2. **CSV file missing or renamed** - Ensure all 4 CSVs exist with exact names
3. **CSV parsing error** - Check for malformed rows (unbalanced quotes, wrong comma count)
4. **CDN down** - ApexCharts or PapaParse CDN unavailable (rare). Replace CDN URLs in HTML.

### Chart shows "No data" or empty
**Symptoms:** Chart renders but no lines/bars
**Fixes:**
1. Domain name in dropdown doesn't match CSV exactly (case-sensitive!)
2. Date columns changed format - must be `Mon D - YYYY` for traffic/DR
3. All traffic values are empty/null for that domain

### Authentication not working
**Symptoms:** Redirects to login forever, "Access Denied" for valid emails
**Fixes:**
1. Check Vercel Environment Variables are set correctly
2. `ALLOWED_EMAILS` must be comma-separated, no spaces: `user1@gmail.com,user2@gmail.com`
3. Google OAuth credentials expired - regenerate in Google Cloud Console
4. Session cookie issues - clear browser cookies, try incognito

### Revenue not showing for a domain
**Symptoms:** Domain appears but revenue bubbles show $0
**Fixes:**
1. Domain name in revenue-history.csv must match traffic-data.csv exactly
2. Revenue values must include `$` symbol
3. Check the domain row exists in revenue-history.csv

### Vercel deployment failed
**Symptoms:** Push succeeded but site shows old version or errors
**Fixes:**
1. Check Vercel dashboard for build errors
2. Verify all files committed (`git status` shows clean)
3. Check vercel.json syntax is valid JSON

### Local development not loading CSVs
**Symptoms:** Works on Vercel but not locally
**Fix:** Must use local server, not `file://` protocol:
```bash
cd traffic-dashboard
python3 -m http.server 8000
# Open http://localhost:8000/index-apex.html
```

---

## Pending / Future Features

### High Priority

- [ ] **Slack Alerting System** - Proactive monitoring via Slack notifications
  
  **Environment Setup:**
  - Add `SLACK_WEBHOOK_URL` to Lambda environment variables
  - Create dedicated Slack channel (e.g., #dashboard-alerts)
  
  **Alert Types:**
  
  1. **Sync Summary** (sent after every successful sync)
     - Files synced with row/column counts
     - Latest date with actual data per file
     - Sync duration
     - Any warnings encountered
  
  2. **Data Freshness Alert** (threshold: 26 hours)
     - Triggers if latest data date is older than threshold
     - Checked per metric: Traffic, DR, Revenue
     - Example: "Traffic data is stale - latest date is Jan 25, 2026 (32 hours old)"
  
  3. **Sync Error Alert** (immediate)
     - Triggers on any sync failure
     - Includes: error type, message, affected file, stack trace
     - Example: "Sync failed: Google Sheets API rate limit exceeded"
  
  4. **Data Quality Alert** (immediate)
     - Row count dropped by >10% vs previous sync
     - Expected columns missing
     - Example: "traffic-data.csv row count dropped from 5072 to 4500 (-11%)"
  
  5. **Value Change Monitor** (checks after each sync)
     - Stores MD5 hash of each CSV after sync
     - Compares to previous sync's hash
     - Alerts if same file unchanged for 3+ consecutive syncs (45 min at 15-min intervals)
     - Tracks per-file: traffic, DR, revenue separately
     - Catches scenario where syncs run but source data (Ahrefs/Google Sheets) hasn't actually updated
     - Example: "DR History.csv unchanged for 3 syncs (45 min) - source data may not be updating"
  
  **Implementation in sync-dashboard.py:**
  ```python
  import hashlib
  import requests
  
  def send_slack_alert(webhook_url, message, alert_type='info'):
      # Format with Slack Block Kit
      # alert_type: 'info', 'warning', 'error'
      pass
  
  def compute_data_hash(csv_content):
      return hashlib.md5(csv_content.encode()).hexdigest()[:12]
  
  # In sync-log.json, store:
  # {
  #   "last_sync": "...",
  #   "data_hashes": {
  #     "traffic-data.csv": {"hash": "abc123", "unchanged_count": 0},
  #     "DR History.csv": {"hash": "def456", "unchanged_count": 2},
  #     ...
  #   }
  # }
  ```

- [x] **Automated data sync** - Lambda syncs Google Sheets to S3 every 15 minutes (EventBridge schedule)

- [ ] **Dashboard Warning Banner** - Visual alert when data is stale
  - Show banner at top of page: "Warning: Traffic data may be stale (last update: Jan 25)"
  - Check latest date in each dataset vs current date
  - Thresholds: Traffic/DR >26 hours, Revenue >2 days
  - Implementation: Add `checkDataFreshness()` function in index-apex.html

- [ ] **Lambda Validation Layer** - Verify data before S3 upload
  - Check row counts match expected range
  - Verify latest date columns have data (not all empty)
  - Validate column count matches expected format
  - Log warnings to CloudWatch if validation fails
  - Still upload data but flag as potentially incomplete

- [ ] **Staged CSV loading** - Load top 100 revenue domains first for fast initial render, then load rest in background. Options: (A) pre-split CSVs, (B) streaming parse, (C) sort CSVs by revenue rank + preview mode
- [ ] **Sales manager assignment** - Add "Sales Manager" column to revenue-history.csv (e.g., "Rina", "Jack", etc.)
- [ ] **Sales manager filter view** - Filter dashboard/leaderboard to show only sites owned by a specific sales manager. Could be dropdown filter or separate page like leaderboard

### Lessons Learned (Jan 28, 2026)

> **Root causes of data sync issues encountered:**

1. **Google Sheets API trailing empty cells** - API omits trailing empty cells from rows, causing Lambda merge to skip new date columns. Fixed by iterating over header length, not row length.

2. **Frontend using local CSV files** - Dashboard was fetching stale local files instead of S3 API endpoints. Fixed by changing all `fetch('*.csv')` to `fetch('/api/data/*')`.

3. **Revenue "Current" column not mapped** - Google Sheet uses "Current" header for current month revenue, but frontend expected "Jan 2026" format. Fixed by adding dynamic mapping of "Current" to current month.

4. **Empty API file** - `traffic-priority.js` was accidentally emptied, causing 500 errors. No automated detection caught this.

5. **No data freshness visibility** - Users had no way to know if displayed data was stale until manually checking.

> **Preventive measures:**
- All data now fetched from S3 via API endpoints (no local CSVs)
- "Last synced X minutes ago" indicator added to leaderboard
- Slack alerting system spec'd (pending implementation)
- Lambda fixes for Google Sheets API quirks


---

## Session Log

> Track significant changes made during Cursor sessions here.

| Date | Change | Notes |
|------|--------|-------|
| Jan 14, 2026 | Initial commit | Plotly dark theme |
| Jan 20, 2026 | CSV integration | Load traffic, revenue, Ahrefs from CSV files |
| Jan 20, 2026 | ApexCharts migration | Replaced Plotly - better zoom/pan, multiple y-axes |
| Jan 20, 2026 | Revenue axis scaling | Bottom-third display, stepped area bars |
| Jan 20, 2026 | DR series iterations | Tried stat card â†’ removed â†’ back on chart as dotted line |
| Jan 20, 2026 | Revenue labels toggle | Slider in header, annotations approach |
| Jan 20, 2026 | Default view Dec 2024 | Added "From Dec 2024" date option |
| Jan 20, 2026 | 100 domains support | Searchable dropdown with keyboard nav |
| Jan 21, 2026 | Dropdown UX | Select all on focus, show full list on click |
| Jan 21, 2026 | Zoom-out bug fix | Use xaxis min/max instead of data filtering |
| Jan 21, 2026 | Revenue ranking bubbles | Lifetime, L3M, Current Month with % of portfolio |
| Jan 21, 2026 | Leaderboard page | All domains with revenue > $0.01, 3 tabs |
| Jan 21, 2026 | Layout fixes | Restored date selector position, aligned nav |
| Jan 21, 2026 | Revenue % precision | Changed to 2 decimal places |
| Jan 23, 2026 | Enhanced .cursorrules | Full lessons learned from git history |
| Jan 23, 2026 | Search engine blocking | robots.txt, meta tags, X-Robots-Tag header |
| Jan 23, 2026 | Google OAuth auth | Serverless API + client-side check, email allowlist, 24hr sessions |
| Jan 23, 2026 | Revenue label positioning | Fixed uniform height near x-axis (was varying with bar height) |
| Jan 23, 2026 | Centered month labels | Xaxis annotations at day 13 of each month, replacing auto datetime labels |
| Jan 23, 2026 | January label highlighting | Bold font weight for Jan labels to mark year boundaries |
| Jan 24, 2026 | Dynamic month calculations | Last 3 Months now uses complete calendar months only, auto-updates |
| Jan 24, 2026 | Rank change tracker | Sites by Agent Current Month tab shows position changes vs previous month |
| Jan 24, 2026 | Avg Last 3 Months bubble | New metric on main dashboard showing average monthly revenue |
| Jan 24, 2026 | Sortable Change column | Moved rank change to separate column, sortable by clicking header |
| Jan 24, 2026 | Leaderboard rank change | Added Change column and sorting to leaderboard Current Month tab |
| Jan 24, 2026 | Filter panel | Added filter button/panel to Current Month tab on leaderboard and agent pages |
| Jan 24, 2026 | Table width increase | Increased max-width from 900px to 1100px, added nowrap to domain cells |
| Jan 27, 2026 | S3 sync bug fix | Fixed Google Sheets API empty cell bug overwriting good data |
| Jan 27, 2026 | Sync status indicator | Added "Last synced X minutes ago" to leaderboard page |
| Jan 27, 2026 | 15-min sync interval | Changed EventBridge from 30 min to 15 min for faster updates |
| Jan 27, 2026 | Slack alerting spec | Documented full Slack notification system in High Priority |
| Jan 28, 2026 | S3 data migration | All data now fetched from S3 via API endpoints, deleted local CSVs |
| Jan 28, 2026 | Site Agent & Niche to S3 | Moved to S3 with new /api/data/agent-niche endpoint (manual upload ~monthly) |
| Jan 28, 2026 | Ahrefs data disabled | Temporarily disabled pending new methodology (UI infrastructure kept) |
| Jan 28, 2026 | Revenue "Current" fix | Map Google Sheet "Current" column to dynamic current month (Jan2026, Feb2026, etc.) |
| Jan 28, 2026 | Monitoring plan documented | Added Dashboard Warning Banner, Lambda Validation, Lessons Learned sections |

---

*Last updated: January 28, 2026 - S3 migration, Revenue "Current" column fix, comprehensive monitoring plan documented*
